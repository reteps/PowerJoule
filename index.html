<!DOCTYPE html>
<html lang="en">

<head>
    <title>Account</title>
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>
    <div class="container">
        <div class="mb-3"></div>
        <div id="urlForm">
            <label for="url">Powerschool URL</label>

            <input type="text" class="form-control" id='url'>
            <small class="form-text">
                The URL found for powerschool login, e.g. https://pschool.aaps.k12.mi.us/public/home.html
            </small>
            <div id="error" class="invalid-feedback mb-3">
                Error
            </div>
        </div>
        <div id="loginForm">
            <input type="text" class="form-control mt-3 mb-3" name='username' id='username' placeholder="Username">
            <input type="password" class="form-control mb-3" name='password' id='password' placeholder="Password">
            <div id="login-error" class="invalid-feedback mb-3">
                Error
            </div>

        </div>
        <div class="d-flex">

            <ul class="pagination">
                <li class="page-item disabled"><a class="page-link" id='back'>Previous</a></li>
                <li class="page-item"><a class="page-link" id="next" href="#">Next</a></li>
            </ul>
            <div id="spinner" class="spinner-border text-primary ml-auto" role="status">
            </div>

        </div>
    </div>
    <script>
        window.$ = window.jQuery = require('jquery')
        const { ipcRenderer } = require('electron')
        $('#loginForm').hide()
        $('#spinner').hide()
        let currentPage = 'url'

        const getHost = (url) => {
            try {
                return new URL(url).origin
            } catch (Error) {
                return ""
            }
        }
        const back = () => {
            $('#loginForm').hide()
            $('#urlForm').show()
            $('#spinner').hide()
            $('#next').removeClass('disabled')
            $('#back').addClass('disabled')
            currentPage = 'url'
        }
        $('#next').click(() => {
            $('#spinner').show()
            if (currentPage === 'url') {
                const url = getHost($('#url').val())
                ipcRenderer.send('url:validate', url)
                return
            }
            console.log('url is', $('#username').val())
            const [user, pass] = [$('#username').val(), $('#password').val()]
            console.log(user, pass)
            ipcRenderer.send('login:validate', { username: user, password: pass })
        })
        $('#back').click(back)

        ipcRenderer.on('url:failure', (e, value) => {
            $('#spinner').hide()
            $('#error').text(value)
            $('#url').addClass('is-invalid')
        })

        ipcRenderer.on('url:success', (e, value) => {
            console.log('Successful.')
            $('#spinner').hide()
            $('#urlForm').hide()
            $('#loginForm').show()
            $('#back').parent().removeClass('disabled')
            currentPage = 'login'
            // $('#next').addClass('disabled')
        })

        ipcRenderer.on('login:success', (e, value) => {
            $('#spinner').hide()
            $('#password').removeClass('is-invalid')
            $('#username').removeClass('is-invalid')
        })
        ipcRenderer.on('login:failure', (e, value) => {
            $('#login-error').text(value)
            $('#spinner').hide()
            $('#password').addClass('is-invalid')
            $('#username').addClass('is-invalid')
        })
    </script>
</body>

</html>